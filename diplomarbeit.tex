%% Dokumentklasse KOMA-Script Report
\documentclass[paper=a4, 12pt]{scrreprt}
%% Encoding UTF8
\usepackage[utf8]{inputenc}
%% 8 Bit Aufloesung der Buchstaben
\usepackage[T1]{fontenc}
%% Seitenraender
\usepackage[scale=0.85]{geometry}
%% Spracheinstellungen
\usepackage[english, naustrian]{babel} % your native language must be the last one!!
%% erweiterte Farbenpalette
\usepackage[dvipsnames]{xcolor}
%% Abbildungen
\usepackage{float}
\usepackage{adjustbox}
%% Tabellen (erweitert)
\usepackage{tabularx}
%% TikZ + Circuit-TikZ (fuer Schaltungen)
\usepackage[europeanresistors, europeaninductors]{circuitikz}
%% Nuetzliche TikZ Libraries
\usetikzlibrary{arrows, automata, positioning}
%% mathematik
\usepackage{amsmath, amssymb}
%\usepackage{mathtools}	
%% pdf-einbindung
\usepackage{pdfpages}
%% scource-code einbindung
\usepackage{listings} %scrhack vermeidet Umschaltung auf KOMA Floats..
\usepackage{courier}
%% euro-symbol
\usepackage{eurosym}
%% landcsape-seiten ermöglichen
\usepackage{lscape}

%% Diplomarbeits-Format
\usepackage{srdpdipa}

%% Abkuerzungsverzeichnis
\usepackage[]{acronym}

%% Todos
\usepackage[]{todonotes}

%% Ganttdiagramme
\usepackage{pgfgantt}

%% Subfigures
\usepackage[lofdepth]{subfig}

\lstdefinestyle{customc}{
	belowcaptionskip=1\baselineskip,
	breaklines=true,
	frame=L,
	xleftmargin=\parindent,
	language=C,
	showstringspaces=false,
	basicstyle=\footnotesize\ttfamily,
	keywordstyle=\bfseries\color{green!40!black},
	commentstyle=\itshape\color{purple!40!black},
	identifierstyle=\color{blue},
	stringstyle=\color{orange},
}


\lstset{escapechar=@,style=customc}

%% definitionen =====================================%%
\dataSchool{HTBLuVA St. Pölten}
\dataDepartment{Höhere Lehranstalt für Elektronik und Technische Informatik}
\dataSubdepartment{Ausbildungsschwerpunkte Embedded Systems}
\dataSession{2019/20}

\title{Universeller hochdynamischer LED-Treiber}
\author{Florian Hintermeier \and Dominik Gansch}
\date{\today}
\place{St. P\"olten}
\professor{Dipl.-Ing. Josef Radlbauer}
%%====================================================%%

% Hyperlinks im Dokument
\usepackage[colorlinks=true,
    linkcolor=black,
    citecolor=green,
    bookmarks=true,
    urlcolor=black,
    bookmarksopen=true]{hyperref}

\begin{document}

\frontmatter

%% titelseite ==========================================%%
\maketitle
%%======================================================%%

%% komplett leere seite ================================%%
\newpage\null\thispagestyle{empty}\newpage
%%======================================================%%

%% eidesstattliche erklärung ===========================%%
\begin{affidavit}
    \unterschrift{Florian Hintermeier}
    \unterschrift{Dominik Gansch}
\end{affidavit}
%%======================================================%%

%% dokumentation (deutsch/englisch) ====================%%
\includepdf[pages=-]{form/dokumentation-de.pdf}
\includepdf[pages=-]{form/dokumentation-en.pdf}
%%======================================================%%

%% inhaltsverzeichnis ==================================%%
\tableofcontents
%%======================================================%%

%% HAUPTTEIL ===========================================%%
\responsible{Florian Hintermeier, Dominik Gansch}
\mainmatter

\chapter{Einleitung}
    Die Firma ZKW möchte für zahlreiche in Entwicklung und bereits in Produktion befindliche LED Einheiten einen universell einsetzbaren LED Treiber mit linear einstellbarem Strom. Dabei soll jede einzelne LED von maximal 84 individuell in ihrer Helligkeit eingestellt werden können.
    
	\begin{adjustbox}{center,caption={Blockschaltbild von ZKW},label={ZKW-Blockschaltbild},nofloat=figure,vspace=\bigskipamount}
	\includegraphics[width=15cm]{img/ZKW_Blockschaltbild.PNG}
	\end{adjustbox}

	Das Ziel liegt darin, eine geeignete Schaltung zu entwickeln um den von ZKW gegebenen Anforderungen zu entsprechen. Zu sehen sind diese in Abbildung 1.1.
	
	Diese Angaben sind:
	\begin{itemize}
		\item{Eingangsspannung zwischen 10 und 15 Volt}
		\item{Einstellbare Ausgangsspannung zwischen bis 42 Volt}
		\item{Einstellbaren Ausgangsstrom zwischen zwischen 0 und 1500mA}
		\item{Mikrocontroller kommunikation über High-Speed-CAN}
		\item{Unterstützung für maximal 7 LED Boards mit gesamt maximal 84 LEDs}
	\end{itemize}
	

\chapter{Individuelle Zielsetzung}
    \section{Hardware}    	
    	\subsection{Analogteil}
        Dieser Teil wird von Florian Hintermeier entwickelt. Der Analogteil enthält die Schaltung um die Angeforderten Spannungen und Ströme erzeugen zu können, die von einem Mikrocontroller eingestellt werden sollen. Die Einstellungen werden von dem Mikrocontroller vom Digitalteil über den DAC eingestellt.
        
        \subsection{Digitalteil}
        Dieser Teil wird von Dominik Gansch entwickelt. Der Digitalteil dient als zentrale Steuerungseinheit. Das Kernstück des Digitalteils besteht aus dem Mikrocontroller welcher über CAN-Bus Befehle, von der ZKW-Application, bestimmte Kommandos erhält. Mithilfe der  CAN-Befehle werden vom Mikrocontrollerinternen DAC die Stromregelungsreferenz eingestellt bzw. sendet der Mikrocontroller die entsprechenden Lichtbilder an die LMMs.% Die CAN-Befehle kann man in zwei Gruppen einteilen, in Befehle für die LMMs und in Stromregelungsbefehle. Für jedes LMM-Kommando gibt es im Mikrocontroller eine entsprechende Lichtbild-Ablauf-Tabelle, diese Daten der Tabelle werden, nach erhalten des dafür entsprechenden Befehls, laufend zu den LMMs gesendet und von diesen umgesetzt, bis der Lichbild-Ablauf abgeschlossen ist. Befehle für die Stromregelung werden mithilfe des internen DACs in einen Spannungsreferenzwert für die Stromregelung umgesetzt. %
    \section{Software}
    	\subsection{Initialisierungen}
    	Dieses Teilgebiet der Softwareentwicklung wird von Florian Hintermeier umgesetzt. Es beschränkt sich auf die Initialisierung der Internen, sowohl auch der Peripherie Funktionalitäten des Mikrocontrollers.
    	\subsection{Controller Area Network}
    	Dieses Gebiet wird ebenfalls von Florian Hintermeier entwickelt. Es handelt sich hierbei um die Kommunikation zwischen User Controlled Device von ZKW mit dem LED-Treiber und des des weiteren um die Kommunikation zwischen Treiber und LED Matrix Manager.
    	Die Kommunikation zum UCD stellt die Grundeinstellungen des Treibers zur Verfügung und diese werden dann umgesetzt und an den LMM weitergegeben.
    	\subsection{Serial Peripheral Interphase}
    	\subsection{ADC/DAC Einstellungen}

\chapter{Grundlagen und Methoden}
	\section{Verwendete Software}
	Die hier aufgeführte und kurz erklärte Software wurde für die Erreichung der Ziele in diesem Projekt verwendet.
	
	\paragraph{LTSpice}\hfill \break
	LTspice ist eine kostenlose Software des ehemaligen Halbleiterherstellers Linear Technology (seit 2017: Analog Devices) zur Schaltungssimulation. Es basiert auf SPICE, ist dazu kompatibel und besonders zur Simulation von Schaltnetzteilen geeignet. Entwickelt und gepflegt wird es von Mike Engelhardt.\footnote{https://de.wikipedia.org/wiki/LTspice}
	\paragraph{Draw.io}\hfill \break
	Draw.io stellt sich als ein technisch anspruchsvolles Diagramm-Tool vor, das im Browser arbeitet und Modellierungssprachen wie UML, ERM und BTPM unterstützt. Die Standard-Version ist kostenlos.\footnote{https://www.tecchannel.de/a/draw-io-kostenloses-diagramm-tool-fuer-den-browser,2078028}
	\paragraph{Altium Designer 19}\hfill \break
	Eines der Hauptziele von Altium ist es, eine integrierte Entwicklungslösung zur Elektronikentwicklung anzubieten.
	Altium Designer beinhaltet die Schaltbildeingabe, einen PCB Layout Editor mit Integritätsanalyse sowie eine auf SPICE-Modellen gestützte Schaltungssimulation.\footnote{https://de.wikipedia.org/wiki/Altium\_Designer}\\
	In diesem Projekt wurde es dazu verwendet, um die Schaltungen zu Zeichnen und das PCB damit zu erstellen.
	\paragraph{TeXstudio}\hfill \break
	TeXstudio ist ein LaTeX-Editor für Windows, Linux, BSD und (Mac) OS X. Er ist open source und basiert auf Texmaker. Wie andere bekannten LaTeX-Editoren bietet auch er die grundlegende Unterstützung beim Einfügen von LaTeX-Befehlen, Syntax-Hervorhebung, eine integrierte Vorschaufunktion und eine Projektfunktion.\footnote{https://latex.tugraz.at/programme/texstudio}
	\paragraph{Atmel Studio}\hfill \break
	Das Atmel Studio (vor Version 6: "AVR Studio") ist eine kostenlose Entwicklungsumgebung (IDE) für die Programmierung der AVR-Mikrocontroller und ARM-Mikrocontroller (ab Version 6) von Atmel. Sie basiert ab Version 5 auf der Visual Studio Shell von Microsoft und besteht aus einer Projektverwaltung, einem Editor, einem Debugger und Werkzeugen zum Beschreiben der Mikrocontroller.\footnote{https://www.mikrocontroller.net/articles/Atmel\_Studio}
	\newpage
	
	\section{Basis des Analogteils}
	Die Basis des Analogteils bildet eine SEPIC Schaltung, das Funktionsprinzip wird unten Beschrieben.
	\paragraph{SEPIC Funktionsprinzip}\footnote{https://www.elektroniknet.de/elektronik-automotive/sonstiges/sepic-wandler-fuer-automotive-anwendungen-1571.html}\hfill \break
	Die Anstiegszeit der Ströme IL1 und IL2 hängen von der Eingangsspannung und von den Induktivitätswerten der Spulen ab. Wenn der Schalter (Q) geschlossen wird, liegt an L1 die Eingangsspannung und an Cs eine Spannung, die genau so groß wie die Eingangsspannung ist. Der Strom steigt in den Spulen L1 und L2 an und Energie wird in den Spulen gespeichert. In dieser Zeit wird die Diode D in Sperrrichtung betrieben und der Ausgangskondensator muss den Strom für die angeschlossene Last liefern. Wenn der Schalter geöffnet wird, kehrt sich die Polarität der Spannung an den Spulen um. Die Diode leitet nun die gespeicherte Energie an den Ausgangskondensator und an die angeschlossene Last.
	\begin{adjustbox}{center,caption={Prinzipschaltung eines SEPIC-Converters},label={fig:SEPIC-Prinzipschaltung},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=10cm]{img/SEPIC_PRinzipschaltung.jpg}
	\hfill \break
	\end{adjustbox}
	\pagebreak
	\section{Basis des Digitalteils}
	Die Basis jeder modernen Digitalschaltung ist ein Mikrocontroller.\hfill \break\break
	Nach diesen Anforderungen wurde dieser ausgewählt:
	\hfill \break 
	\begin{center}
	\begin{minipage}{0.5\textwidth}
	\begin{itemize}
		\item High-Speed CAN-Bus
		\item Erweiterte CAN-Bus Adressbits
		\item Zwei unabhängige CAN-Bus Schnittstellen
		\item Integrierter ADC
		\item Integrierter DAC
		\item Ausreichend IO-Pins
		\item keine komplexe Grundbeschaltung
		\item 5V oder 3,3V Versorgung
	\end{itemize}
	\end{minipage}
	\end{center}
	\hfill \break
	Als perfekte Wahl stellte sich der AT32UC3C2512C von Microchip heraus. Dieser erfüllt alle Anforderungen und ist noch dazu Preiswert.
	\hfill \break
	\begin{adjustbox}{center,caption={AT32UC3C2512C im QFN-64 Package},label={fig:uC Package},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=10cm]{img/AT32UC3C2512C.png}
		\hfill \break
	\end{adjustbox}
	\pagebreak
		
	\section{Grundkonzept der Stromquelle}
	\begin{adjustbox}{center,caption={Grundkonzept der Stromquelle},label={fig:Grundkonzept},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=\textwidth]{img/Diplomarbeit_Blockschaltbild.jpg}
		\hfill \break
	\end{adjustbox}
	Der Aktuelle stand des Schaltungskonzepts wurde in einen Blockschaltbild festgehalten.
	Diese Vorgehensweise war ungemein wichtig damit der Auftraggeber sich ein genaueres Bild der Arbeit machen konnte und ob das Projekt den Anforderungen gerecht entwickelt wird.
	\newpage
	
	\section{Programmierung}
	Der Verwendete Mikrocontroller ist der AT32UC3C2512C, ein 32-Bit Prozessor mit 64KB SRAM, 512KB Programmspeicher und 66MHz maximaler CPU Frequenz von Microchip.
	
	Da ein Mikrocontroller mit einer 32-Bit Architektur gewählt wurde, sind auch die Funktionen anders, als bei den in der HTL verwendeten 8-Bit Controllern. Zu beachten ist dabei, dass die Registerzugriffe vollkommen anders aussehen. Auch gibt es bei der AT32 Serie, die in dieser Diplomarbeit verwendet wurde, die Möglichkeit für jeden PIN eine von sechs verschiedenen Hardware-Funktionen zu übernehmen. Diese verschiedenen Funktionen kann man dem Datenblatt entnehmen.\footnote{http://ww1.microchip.com/downloads/en/DeviceDoc/doc32117.pdf Seite 11}
	\begin{adjustbox}{center,caption={Ausschnitt aus der Peripheral Multiplexing Tabelle},label={fig:PeripheralMultiplexRegisterTabelle.PNG},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[width=\textwidth]{img/Peripheral_Multiplex_Register_Tabelle.PNG}
	\end{adjustbox}
	Wie oben beschrieben und auch im Bild zu sehen, kann jeder Pin bis zu sechs verschiedene Funktionen haben, in diesem Beispiel müsste man für USART RX und TX die GPIO Ports auf Mode E initialisieren.
	\lstinputlisting[language=c, caption=GPER Beispiel]{src/gpioExample.c}
	
	Die Tabelle\footnote{http://ww1.microchip.com/downloads/en/DeviceDoc/doc32117.pdf Seite 468} für das Peripheral Multiplex Register findet man auch im Datenblatt des Mikrocontrollers, dort kann man herauslesen, was bei pmr[n] eingestellt werden muss.
	\begin{adjustbox}{center,caption={Peripheral Multiplex Register Mode Tabelle},label={fig:PeripheralFunktions.PNG},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=4cm]{img/Peripheral_Funktions.PNG}
	\end{adjustbox}
	Um diese Mikrocontroller spezifischen Funktionen verwenden zu können, braucht man folgende Headerfiles im C-Code:
	\begin{itemize}
		\item inttypes.h
		\item avr32/io.h
	\end{itemize}

	Weitere verwendete Headerfiles:
	\begin{itemize}
		\item math.h
	\end{itemize}
	
	
\chapter{Ergebnisse}
	\section{Analogteil}
	Da die Eingangsspannung mit der das Gerät versorgt werden soll, zwischen 10 und 15 Volt liegt, muss man die Spannung erhöhen, was in diesem Fall mit einem SEPIC-Converter passiert. Als Basis dafür wurde der LT3757 Verwendet.\hfill \break
	Die Grundbeschaltung wurde aus dem Datenblatt\footnote{https://www.analog.com/media/en/technical-documentation/data-sheets/3757Afe.pdf Seite 31} übernommen, die benötigten Bauteilwerte wurden jedoch mittels Simulationen mit LTSpice ermittelt. 
	\begin{adjustbox}{center,caption={Referenzschaltung für SEPIC}, label={fig:LTSpice-Schaltung-Analogteil},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=7cm]{img/Referenzschaltung_SEPIC.PNG}
	\end{adjustbox}
	
		\subsection{Schaltung}
			\subsubsection{LTSpice}
			\begin{adjustbox}{center,caption={Simulationsschaltung des Analogteils in LTSpice},label={fig:LTSpice-Schaltung-Analogteil},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/LTSpice_Schaltung_Analogteil.PNG}
			\end{adjustbox}
			\pagebreak
			\subsubsection{Altium}
			Die Schaltung in Altium wurde für eine bessere Übersicht in mehrere Teile aufgeteilt. Um trotzdem die Verbindung zwischen den einzelnen Leitungen herzustellen wurden sogenannte Ports verwendet, das sind Verbindungen mit Gleichnamigen Kästchen.
			\paragraph{SEPIC}
			\begin{adjustbox}{center,caption={Grundbeschaltung des LT3757},label={fig:LT3757-Grundbeschaltung},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/SEPIC_Altium.PNG}
			\end{adjustbox}
			Oben abgebildet ist die Grundbeschaltung des SEPIC-Chip LT3757. Das RC-Netzwerk bei dem VC-Pin hält die Spannung für die Erzeugung der Internen Spannung stabil erzeugt wird stabil gehalten werden kann. Am RT-Pin wird mittels des Wiederstandes eine Schaltfrequenz eingestellt. Der Pin INTVCC ist da um die Spannungen für die Interne Versorgung und das Gate stabil zu halten.
			\paragraph{Undervoltage Shutdown für SEPIC}
			\begin{adjustbox}{center,caption={Undervoltage Shutdown Schaltung für LT3757},label={fig:uvlo},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[height=6cm]{img/Undervolteage_Shutdown_SEPIC.PNG}
			\end{adjustbox}
			Dieser Teil der Schaltung ist dafür zuständig, dass die Spannung am Eingang überprüft wird, wenn die Spannung zu klein ist, wird der SEPIC-Chip deaktiviert um keine Schäden verursachen zu können.
			\pagebreak
			\paragraph{Feedback Schaltung für SEPIC}
			\begin{adjustbox}{center,caption={Feedback Schaltung für SEPIC},label={fig:feedback},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[height=6cm]{img/Feedback_SEPIC.PNG}
			\end{adjustbox}
			Dieser Teil ist zuständig für das Feedback der Spannung, die die Schaltfrequenz des FETs einstellt, über den auch die Ausgangsspannung eingestellt wird. Eingestellt wird die Schaltfrequenz mit dem Spannungsteiler von R203 und R204/R213, welcher Verwendet wird, hängt von der Jumper Einstellung ab, es soll immer so sein, dass die Spannung am FBX-PIN 1,6 Volt beträgt.
			
			Die Z-Diode wird Deshalb benötigt, weil die Spannung bei änderung des Widerstandes höher werden kann, es wird dann vom LT3757 so geregelt, dass innerhalb kürzester Zeit wieder die gewollten 1,6V anliegen. Jedoch ist es für das Digitale Potentiometer schädlich, wenn eine Spannung höher als die Versorgungsspannung anliegt. Deshalb wurde die Z-Diode verbaut, um die Maximale Spannung, die anliegt auf 3,9V zu begrenzen.
			\paragraph{Regelung für SEPIC}
			\begin{adjustbox}{center,caption={Regelungsschaltung für LT3757},label={fig:regelung},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/Regelung_SEPIC.PNG}
			\end{adjustbox}
			Der SENSE-PIN misst den Strom am FET, wenn der zu groß ist, wird ausgeschaltet. Die Spulen L1 und L2 sind gegengleich gekoppelt mit einem Verhältnis von 1 zu 1. Am Ausgang (OUT) liegt dann die mit den Widerständen von der Feedback Schaltung eingestellte Spannung.
			\pagebreak
			\paragraph{Negative Spannung}
			\begin{adjustbox}{center,caption={Schaltung für Versorgung von OPV der Stromquelle},label={fig:neg-spg},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[height=9cm]{img/Negative_Spannung.PNG}
			\end{adjustbox}
			Diese Schaltung dient dazu, eine Spannung zu erzeugen, die immer 8,2V unter der Spannung von (OUT) liegt. Die niedrigere Spannung liegt an dem Punkt U-Neg-OUT. In einer Simulation in Abbildung \ref{fig:LTSpice-Simulation-1} kann man den Spannungsunterschied zwischen V(out) und V(uneg) sehen.
			\paragraph{Stromquelle}
			\begin{adjustbox}{center,caption={Schaltung für die Einstellbare Stromquelle},label={fig:stromquelle},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[height=8cm]{img/Stromquelle_SEPIC.PNG}
			\end{adjustbox}
			Bei dieser Schaltung wird ein Stromspiegel verwendet um den Strom mit dem ADC des Mikrocontrollers messen zu können. Weiters wird der maximale Strom mit der Spannung am Plus Eingang des OPV (U203) mit dem DAC des Mikrocontrollers eingestellt.
			
		\subsection{Simulation}
			\begin{adjustbox}{center,caption={Simulation der Schaltung Mittels LTSpice},label={fig:LTSpice-Simulation-1},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/LTSpice_Simulation_1.PNG}
			\end{adjustbox}
			Wie in Abbildung \ref{fig:LTSpice-Simulation-1} zu sehen, ist in der Simulation die Eingangsspannung(in) auf 10 Volt eingestellt, der SEPIC-Converter braucht hier ca. 2,75ms um die Ausgangsspannung(out) auf konstante 50 Volt einzustellen. Bei der Simulierten Belastung von 40 Ohm(Rlast) wird ca 1 Ampere aus der Schaltung gezogen. Das entspricht auch den Leistungsanforderungen der Firma, welche die maximale benötigte Ausgangsleistung mit 40 Watt angegeben hat. 
			
			\begin{align*} 
			P_{out} = U_{out} \cdot I_{Rlast} = 50V \cdot 1A = 50W
			\end{align*} 
			
			Laut Simulation hat diese Schaltung eine Ausgangsleistung von 50W, was sogar mehr ist als angegeben. 
			\ref{fig:LTSpice-Simulation-1} zu sehen, ist
			\begin{adjustbox}{center,caption={Simulation der Schaltung Mittels LTSpice},label={fig:LTSpice-Simulation-2},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/LTSpice_Simulation_2.PNG}
			\end{adjustbox}
			
			Die Frequenz am GATE ist nach ca 2,75ms stabil, genauso wie V(out) in Abbildung \ref{fig:LTSpice-Simulation-1}. 
			
			\subsubsection{Spannungseinstellung}
			Um herauszufinden wie sich die Spannung bei Widerstandsänderung verändert, wurde dies auch mithilfe von LTSpice herausgefunden.
			
			Grundsätzlich ist es so:
			\begin{itemize}
				\item Hoher Widerstand -> Niedrige Spannung
				\item Niedriger Widerstand -> Hohe Spannung
			\end{itemize}
			
			Es ist schon bekannt, dass 50V die maximale Spannung ist, die noch stabil eingestellt werden kann. Diese Simulation hat ergeben, dass die niedrigste einstellbare Spannung 3,21V beträgt.
			
			Einige Werte dazwischen sind in diesem Diagramm abzulesen:
			\begin{adjustbox}{center,caption={Spannungsverlauf bei Widerstandsänderung},label={fig:spgVLbWdst},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/simulationSPG.PNG}
			\end{adjustbox}
		
			In dem Diagramm kann man sehen, dass die Zeit bis die Ausgangsspannung stabil ist, immer kürzer wird, je näher man der Eingangsspannung kommt, diese war in diesem Fall 10V. Das liegt daran, dass die Schaltung weniger herunter oder hinauf wandeln muss wenn die Ausgangsspannung der Eingangsspannung näher ist.
		
			\subsubsection{Ergebnisse der Simulationen}
			{\large \textbf{Maximale Spannung:} 51,2V} \hfill \break
			{\large \textbf{Minimale Spannung:} 3,2V}\hfill \break
			{\large \textbf{Stabiler Spannungszustand:} nach durchschnittlich 1,74ms} \hfill \break
			\newpage
			
			\subsubsection{Berechnungen}
			\label{sec:berechnungen}
			Aufgrund der Simulation der Spannungseinstellungen weiß man, wie die Spannungskurve aussieht. Auf Grundlage dieser wurde eine Hyperbelfunktion aufgestellt, welche die Berechnungen für die einzustellenden Widerstandswerte für das Mikrocontroller-Programm ermöglicht. \hfill \break \hfill \break
			\textbf{Die Funktion:} 
			\begin{align*} 
			U_{out}(R) = 200 \cdot R^{-1,1} + 2
			\end{align*}
			Die Kurve der Funktion passt zu den benötigten Spannungswerten ab einem Widerstandswert von 4Ω. Alle Spannungswerte zwischen Widerstandswerten von 4Ω und 100Ω passen zu denen aus der Simulation.
			\begin{adjustbox}{center,caption={Berechneter Spannungsverlauf bei Widerstandsänderung},label={fig:berechnungSPG},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/berechnungSPG.PNG}
			\end{adjustbox}
			Im späteren Verlauf wird die Einzustellende Spannung bekannt gemacht, da man vom UCD die einzuschaltenden LEDs übertragen bekommt. Das heißt man muss in diesem Fall nicht nach der Ausgangsspannung Berechnen, da diese bekannt ist, sondern nach dem Widerstandswert. \hfill \break \hfill \break
			\textbf{Formel zur Berechnung des Widerstandswertes:}
			\begin{align*} 
			R=\frac{ U - 2 }{ 200 }^{ -\frac{ 1 }{ 1,1 } }
			\end{align*}
			\textbf{Formel zur Berechnung des Widerstandswertes in C Code:}
			\lstinputlisting[language=c, caption=C-Code für Widerstandsberechnung]{src/widerstandBerechnung.c}
			\pagebreak
			 
			
			\subsubsection{Simulation eines Anwendungsfalls}
			Von der Firma ZKW kommen verschiedene Anwendungsfälle, um zu Testen ob die SChaltung so funktioniert, wie sie es brauchen, wird einer der Fälle simuliert, statt dem LED-Strang kommt in der Simulation ein Widerstand zum Einsatz, an dem Gleich viel Spannung abfällt.
			\begin{adjustbox}{center,caption={Anwendungsfall von ZKW},label={fig:anwendungsfall},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/SimulierterAnwendungsfall.PNG}
			\end{adjustbox}
			In diesem Fall brauchen die LEDs eine Spannung von 35V. Wie aus dem Diagramm herauszulesen, wird der Widerstand in der Simulation geändert auf 4.4kΩ. Das ist zwar eine Spannung von 37V, da die Schaltung für die Strommessung und Einstellung selbst ein paar Volt braucht, 2V um genau zu sein. Somit sind die 35V für die LEDs zu haben. 
			\pagebreak
			
			
	\section{Digitalteil}
		\subsection{Schaltung}
		\begin{adjustbox}{center,caption={Mikrocontroller Grundbeschaltung},label={fig:uC Grundbeschaltung},nofloat=figure,vspace=\bigskipamount}
			\includegraphics[height=12cm]{img/Grundbeschaltung_uC.PNG}
		\end{adjustbox}
	Fast alle passiven Bauelemente welche in der Abbildung \ref{fig:uC Grundbeschaltung} zu sehen sind werden für die Grundfunktionen benötigt. Die Kondensatoren (C110 \& C111) beim 16MHz Quarz (X101) werden für den internen Oszillator benötigt. Für die Stabilität des internen LDO wurden die Kondensatoren mit 100nF \& 470pF dimensioniert.
	Alle anderen Kondensatoren sind Stützkondensatoren. Die Taster (T101 \& T101) werden für die Programmierung oder auch für den Reset des Mikrocontrollers benötigt. Die Programmierung erfolgt über USB und als physikalische Schnittstelle wurde eine Mikro-USB Buchse gewählt. RXD und TXD sind die Datenleitungen zum CAN-Transceiver. 
		\begin{adjustbox}{center,caption={CAN-Transceiver},label={fig:CAN-Transceiver},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=5cm]{img/CAN_Tranceiver.PNG}
		\end{adjustbox}
	Für die Steuerung des Analogteils wurde ein Digitales-Poti verwendet welches über die SPI-Schnittstelle angesteuert wird, des weiteren werden der interne DAC und ADC auch für die Steuerung des Regelkreises mit eingebunden. Für die Versorgung wurde die Betriebsspannung auf 5V geregelt.
	\begin{adjustbox}{center,caption={VoltageRegulator 7805 },label={fig:VoltageRegulator.PNG},nofloat=figure,vspace=\bigskipamount}
		\includegraphics[height=5cm]{img/VoltageRegulator.PNG}
	\end{adjustbox}
	\newpage
	
	\section{Hardware}
		\subsection{PCB}
	\newpage
	
	\section{Software}
		\subsection{Programmablauf}
		Um die Programmierung bestmöglich umsetzen zu können, ist es sinnvoll einen Programmablaufplan zu erstellen, mithilfe davon ist es einfacher Abläufe des Programms zu Planen und diese auch nachzuvollziehen und zu verstehen.
		\begin{adjustbox}{center,caption={Programmablaufplan},label={fig:PAP.png},nofloat=figure,vspace=\bigskipamount}
			\includegraphics[height=18cm]{img/Dyn-LED-Driver-PAP.png}
		\end{adjustbox}
		Für noch besseres Verständnis der Abläufe im Prgramm folgt hier zusätzlich zum Programmablaufplan noch eine Detaillierte Erklärung der einzelnen Elemente davon. Oben Angefangen und nach unten aufgearbeitet. 
		\newpage
		\subsubsection{Initialisierung}
		Um die Gewünschte Funktionalität des Mikrocontrollers zu aktivieren müssen vor dem Eigentlichen Programmablauf alle Peripherie und auch interne Funktionen erst initialisiert werden. Dies wird mittels Bitschieben in den einzelnen Registern gemacht. \hfill \break \hfill \break		
		\textbf{Zu initialisierende Funktionen:}
		\begin{itemize}
			\item Externe Taktquelle
			\item Controller Area Network
			\item Serial Peripheral Interface
			\item Analog Digital Converter
			\item Digital Analog Converter
		\end{itemize}
	
		\subsubsection{Ablauf}
		Nach der Initialisierung geht es direkt ins Hauptprogramm über, hier wird ständig überprüft, ob vom User Controlled Device eine Anfrage an den Mikrocontroller gemacht wurde. Hier gibt es zwei Möglichkeiten, entweder, eine Anfrage wurde getätigt, dann wird diese Ausgewertet. Ist aber keine Anfrage getätigt worden, beginnt es von neuem.\hfill \break \hfill \break
		Es gibt zwei Mögliche anfragen, die Ausgewertet werden können, diese sind die Abfrage des Stromes der gerade gezogen wird und die Anweisung den Strom zu ändern oder LEDs ein oder auszuschalten.\hfill \break \hfill \break
		Soll der Strom gemessen werden, wird eine ADC Messung durchgeführt, die Ergebnisse davon werden dann ausgewertet und per CAN wieder an das User Controlled Device zurückgesendet.\hfill \break \hfill \break
		Beim einstellen der LEDs wird ausgewertet, wie viele LEDs am Modul noch eingeschaltet sind, nach dem richtet sich die Spannung. Die Spannung wird durch das Verändern eines Spannungsteilers am Feedback Eingang des SEPIC Chips eingestellt. Dieser Spannungsteiler wird durch ein Digitales Potentiometer verändert, dieses bekommt den Widerstand so eingestellt, dass die gewünschte Ausgangsspannung anliegt. Wie man auf die werden kommt, kann im  \hyperref[sec:berechnungen]{Kapitel Berechnungen} nachgelesen werden.\hfill \break \hfill \break
		Soll der Ausgangsstrom verändert werden, wird mithilfe des DACs die Spannung an einem der Operationsverstärker, die einen für den Stromfluss zuständigen MOSFET ansteuern, verändert. Nach dieser Änderung, wird eine ADC Messung durchgeführt, ob nun der Richtige Strom fließt, ist das nicht der Fall, wird überpüft ob zu viel oder zu wenig Strom fließt, nochmals mit dem DAC eingestellt und danach wieder gemessen, so lange, bis der Wert stimmt. Sollte es gleich beim ersten mal der gewünschte wert sein, wird ganz von vorne begonnen und auf UCD Anfragen kommen.
		\newpage
		
		\subsection{Controller Area Network}
			\subsubsection{Grundlagen zu CAN}
			Mit CAN werden mehrere gleichberechtigte Komponenten miteinander verbunden und können somit miteinander kommunizieren. Sehr beliebt ist es, wegen seiner Störsicherheit und der Echtzeitfähigkeit. Eingesetzt wird es häufig im Automobilbereich, und der Medizintechnik aber auch in vielen weiteren Systemen.
			
			Die Übertragung wird über zwei Leitungen bewerkstelligt, womit die Fehleranfälligkeit, dank der Pegelunterschiede auf ein Minimum Beschränkt wird. In folgender Grafik kann man sehen, wie diese bitweise Übertragung auf den beiden CAN Leitungen aussieht.
			\begin{adjustbox}{center,caption={CAN Übertragung},label={fig:CANbits.png},nofloat=figure,vspace=\bigskipamount}
				\includegraphics[width=\textwidth]{img/CAN_bits.png}
			\end{adjustbox}
		
			In diesem Fall wird Highspeed-CAN verwendet, was eine Übertragungsgeschwindigkeit von 1 Mbits/s ermöglicht.
			\newpage
			
			\subsubsection{Initialisierung von CAN}
			Um CAN zu initialisieren müssen pro CAN-Interface mindestens sechs Register beschrieben werden.
			Welche das sind, ist im Datenblatt zu finden, ab Seite 762. 
			Grundsätzlich sieht die CAN Initialisierung für diesen Anwendungsfall bei einem Interface wie folgt aus:
			\lstinputlisting[language=c, caption=CANIF1 Initialisierung]{src/canInit.c}
			Im oben sichtbaren C-Code sieht man die Portpin initialisierungen in den Richtigen Modus. Weiters kann man sehen, wie die Konfiguration für diesen CAN Kanal durchgeführt wird. Im Letzen Berecuh ist zu sehen, wie für diesen CAN Kanal einzelne Kontrollwerte eingestellt werden.
			Die Wichtigsten Werte hier sind:
			\begin{itemize}
				\item Externer interrupt: aktiviert (wenn eine Übertragung stattfindet, wird diese sofort registriert)
				\item Overload handling: deaktiviert (wenn eine zu lange Übertragung festgestellt wird, wird nichts unternommen, da dies nicht vorkommen sollte)
				\item Anfragen auf den Kanal: aktiviert
				\item Kanal generell freischalten: aktiviert
			\end{itemize}
			\newpage 
			
			\subsubsection{User Controlled Device}
			\subsubsection{LED Matrix Manager}
			Für die Kommunikation mit dem LMM sind einige Programmteile zuständig. Wie in einem vorherigen Kapitel schon beschrieben, auch die Initialisierungen. Hier werden aber Hauptsächlich die Teile beschrieben, welche sich um das Zusammensetzen der Nachrichten und die Aufnahme der Acknowledge Nachricht des LMM kümmern. 
			\newpage
			
		\subsection{Serial Peripheral Interface}
			\subsubsection{Grundlagen zu SPI}
			\subsubsection{Digitales Potentiometer}
			\newpage
		\subsection{Digital Analog Converter}
			\subsubsection{Grundlagen zum DAC}
			\newpage
		\subsection{Analog Digital Converter}
			\subsubsection{Grundlagen zum ADC}
			\newpage



%% ANHANG ==============================================%%
\appendix

%% abkürzungsverzeichnis ===============================%%
\input{tex/abkuerzungen.tex}
%%======================================================%%

%% abbildungsverzeichnis ===============================%%
\setcounter{lofdepth}{2}
\dipalistoffigures
%%======================================================%%

\lstlistoflistings


%% tabellenverzeichnis =================================%%
%\setcounter{lotdepth}{2}
%\dipalistoftables
%%======================================================%%

%% danksagungen=========================================%%
%%\input{tex/danksagungen.tex}%% Für Diplomarbeit hinzufügen
%%======================================================%%

%% literaturverzeichnis ================================%%
%%\newewpage
%%\input{tex/literatur.tex}
%%======================================================%%

%% betreuungsprotokolle ================================%%
\includepdf[pages=-]{seminare/First_DA_Seminar.pdf}
\includepdf[pages=-]{seminare/Second_DA_Seminar.pdf}
\includepdf[pages=-]{seminare/Third_DA_Seminar.pdf}
\includepdf[pages=-]{seminare/Fourth_DA_Seminar.pdf}
\includepdf[pages=-]{seminare/Fifth_DA_Seminar.pdf}
\includepdf[pages=-]{seminare/Sixth_DA_Seminar.pdf}
\includepdf[pages=-,angle=90]{schaltungen/Dynamic_LED_Driver.pdf}
\includepdf[pages=-,angle=90]{schaltungen/Bauteilliste.pdf}
%%=====================================================%%
\end{document}
